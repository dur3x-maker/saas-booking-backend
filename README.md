# SaaS Booking

Multi-tenant платформа для онлайн-записи на услуги. Масштабируемая альтернатива Yclients / Dikidi с акцентом на чистую архитектуру, изоляцию данных между бизнесами и корректную обработку конкурентных бронирований.

Система позволяет нескольким пользователям управлять несколькими бизнесами через единый API и веб-интерфейс. Каждый бизнес содержит собственный набор сотрудников, услуг, клиентов, расписаний и бронирований. Доступ к данным бизнеса контролируется через JWT-аутентификацию и заголовок `X-Business-ID`.

## Стек технологий

### Backend

- **FastAPI** -- HTTP-фреймворк
- **SQLAlchemy 2.0** -- ORM
- **Alembic** -- миграции базы данных
- **SQLite** (WAL mode) -- хранилище данных
- **python-jose** -- JWT-токены (HS256)
- **passlib + bcrypt** -- хеширование паролей

### Frontend

- **Next.js 14** (App Router) -- React-фреймворк
- **TypeScript** -- типизация
- **TailwindCSS** -- стилизация
- **React 18** -- UI-библиотека

## Архитектура

### JWT-аутентификация

При регистрации создается пользователь (`users`). При логине выдается JWT-токен:

```json
{
  "sub": "42",
  "iat": 1739271600,
  "exp": 1739358000,
  "jti": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

- **sub** -- идентификатор пользователя
- **iat** -- время выдачи токена
- **exp** -- время истечения (по умолчанию 24 часа)
- **jti** -- уникальный идентификатор токена (UUID v4)

Токен передается в заголовке `Authorization: Bearer <token>`.

### X-Business-ID scoping

Все tenant-scoped эндпоинты требуют заголовок `X-Business-ID`. Система проверяет, что текущий пользователь имеет доступ к указанному бизнесу через таблицу `business_users`. Если заголовок отсутствует -- возвращается `400`. Если у пользователя нет доступа -- `403`.

Это обеспечивает полную изоляцию данных между бизнесами на уровне каждого запроса.

## Модель ролей

Связь пользователя с бизнесом хранится в таблице `business_users` с полем `role`:

| Роль | Описание |
|------|----------|
| **owner** | Полный доступ. Может управлять участниками бизнеса, менять роли, приглашать и удалять пользователей. |
| **admin** | CRUD сотрудников, услуг, клиентов, расписаний, бронирований. Не может управлять участниками бизнеса. |

Иерархия: `owner > admin`. Один пользователь может быть участником нескольких бизнесов с разными ролями.

## Бизнес-логика бронирования

1. Клиент выбирает сотрудника, услугу и время
2. Система проверяет: рабочие часы, отсутствия (time-off), пересечения с существующими бронированиями
3. Бронирование создается в статусе `HOLD` или `CONFIRMED`
4. `HOLD` автоматически истекает через заданное время
5. Конкурентный доступ обеспечивается через `BEGIN IMMEDIATE` (SQLite) -- два параллельных бронирования на один слот невозможны
6. При бронировании автоматически создается или находится клиент по номеру телефона (get-or-create)

## Запуск локально

```bash
# Клонирование
git clone <repo-url>
cd saas-booking-backend

# Установка зависимостей
pip install -r requirements.txt

# Применение миграций
python -m alembic upgrade head

# Запуск сервера
python -m uvicorn app.main:app --host 127.0.0.1 --port 8000

# Документация API
# http://127.0.0.1:8000/docs
```

Переменные окружения (опционально):

| Переменная | По умолчанию | Описание |
|---|---|---|
| `JWT_SECRET` | `CHANGE_ME_LATER` | Секрет для подписи JWT |
| `JWT_ALG` | `HS256` | Алгоритм подписи |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | `1440` | Время жизни токена (минуты) |

## Примеры curl-запросов

### Регистрация

```bash
curl -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email": "owner@example.com", "password": "secret123"}'
```

### Логин

```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "owner@example.com", "password": "secret123"}'
# -> {"access_token": "eyJ...", "token_type": "bearer"}
```

### Создание бизнеса

```bash
curl -X POST http://localhost:8000/api/v1/businesses/ \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"name": "My Salon", "timezone": "Europe/Moscow"}'
```

### Приглашение администратора

```bash
curl -X POST http://localhost:8000/api/v1/business-users/invite \
  -H "Authorization: Bearer <token>" \
  -H "X-Business-ID: 1" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "role": "admin"}'
```

### Tenant-scoped эндпоинт (список сотрудников)

```bash
curl http://localhost:8000/api/v1/staff \
  -H "Authorization: Bearer <token>" \
  -H "X-Business-ID: 1"
```

### Текущий пользователь (/me)

```bash
curl http://localhost:8000/api/v1/me \
  -H "Authorization: Bearer <token>"
```

### Текущий контекст бизнеса (/context)

```bash
curl http://localhost:8000/api/v1/context \
  -H "Authorization: Bearer <token>" \
  -H "X-Business-ID: 1"
```

## Frontend

Веб-интерфейс расположен в директории `frontend/`.

### Страницы

| Страница | Путь | Описание |
|---|---|---|
| Логин / Регистрация | `/login` | Вход и регистрация пользователя |
| Обзор | `/dashboard` | Выбор бизнеса или создание первого бизнеса |
| Сотрудники | `/dashboard/staff` | CRUD сотрудников |
| Услуги | `/dashboard/services` | CRUD услуг + привязка к сотрудникам (many-to-many) |
| Расписание | `/dashboard/schedule` | Управление рабочими часами сотрудников по дням недели |
| Клиенты | `/dashboard/customers` | Список клиентов |
| Бронирования | `/dashboard/bookings` | Список бронирований с подтверждением и отменой |
| Календарь | `/dashboard/calendar` | Выбор сотрудника → услуги → даты → доступные слоты → создание бронирования |

### Запуск frontend

```bash
cd frontend
npm install
npm run dev
# http://localhost:3000
```

Переменные окружения (`frontend/.env.local`):

| Переменная | По умолчанию | Описание |
|---|---|---|
| `NEXT_PUBLIC_API_URL` | `http://127.0.0.1:8000` | URL backend API |

### Полный рабочий флоу

1. Регистрация / Логин
2. Создание бизнеса
3. Добавление сотрудника
4. Создание услуги + привязка к сотруднику
5. Настройка расписания сотрудника
6. Календарь → выбор слота → бронирование
7. Просмотр и управление бронированиями

## Статус проекта

MVP -- backend + frontend. Полный рабочий цикл от регистрации до бронирования.
